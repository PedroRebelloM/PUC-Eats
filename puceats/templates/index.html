{% extends 'base.html' %}
{% load static %}

{% block title %}PUC Eats{% endblock %}

{% block nav_index %}active{% endblock %}

{% block header_extra_buttons %}
<button class="icon-btn" id="sidebarToggle">
    <span class="material-icons">chevron_left</span>
</button>
{% endblock %}

{% block content %}
    <div class="main-container">
        <div id="map"></div>

        <aside class="sidebar" style="overflow-y: auto;">
            <div class="sidebar-header">
                <h2>Restaurantes</h2>
                <p class="sidebar-subtitle">Lugares próximos para comer</p>
            </div>

            <div class="restaurant-list">
                {% for restaurant in restaurants %}
                <div class="restaurant-item" onclick="handleRestaurantClick(event, {{ restaurant.id }})">
                    <div class="restaurant-image">
                        {% if restaurant.logo %}
                        <img src="{{ restaurant.logo.url }}" alt="{{ restaurant.name }}">
                        {% else %}
                        <div class="restaurant-placeholder">
                            <span class="material-icons">restaurant</span>
                        </div>
                        {% endif %}
                    </div>
                    <div class="restaurant-info">
                        <h3 class="restaurant-name">{{ restaurant.name }}</h3>
                        <p class="restaurant-location">{{ restaurant.building|default:"Campus PUC" }}</p>
                        <p class="restaurant-cuisine">{{ restaurant.get_cuisine_type_display }}</p>
                    </div>
                    <button class="favorite-btn" data-restaurant-id="{{ restaurant.id }}" title="Adicionar aos favoritos">
                        <span class="material-icons">favorite_border</span>
                    </button>
                </div>
                {% empty %}
                <p style="text-align: center; color: #666; padding: 20px;">
                    Nenhum restaurante cadastrado ainda.
                </p>
                {% endfor %}
                
                <div id="noResultsMessage" style="display: none; text-align: center; padding: 40px; color: #666;">
                    <span class="material-icons" style="font-size: 48px; color: #ccc;">search_off</span>
                    <p style="margin-top: 12px; font-size: 16px;">Nenhum restaurante encontrado</p>
                    <p style="margin-top: 8px; font-size: 14px; color: #999;">Tente buscar por outro termo</p>
                </div>
            </div>
        </aside>
    </div>

    <div id="restaurantModal" class="restaurant-modal-overlay">
        <div class="restaurant-modal-content">
            <div class="restaurant-modal-header">
                <h2 id="modalRestaurantName">Carregando...</h2>
                <div class="modal-header-actions">
                    <button class="favorite-btn modal-favorite-btn" data-restaurant-id="" title="Adicionar aos favoritos">
                        <span class="material-icons">favorite_border</span>
                    </button>
                    <button class="restaurant-modal-close" onclick="closeRestaurantModal()">
                        <span class="material-icons">close</span>
                    </button>
                </div>
            </div>
            <div class="restaurant-modal-body" id="modalRestaurantBody">
                <p style="text-align: center; padding: 20px;">Carregando cardápio...</p>
            </div>
        </div>
    </div>

    <div id="dishDetailModal" class="dish-detail-overlay">
        <div class="dish-detail-content">
            <div class="dish-detail-header">
                <h2 id="dishDetailName">Carregando...</h2>
                <button class="dish-detail-close" onclick="closeDishDetailModal()">
                    <span class="material-icons">close</span>
                </button>
            </div>
            <div class="dish-detail-body" id="dishDetailBody">
                <p style="text-align: center; padding: 20px;">Carregando detalhes...</p>
            </div>
        </div>
    </div>
{% endblock %}

{% block extra_scripts %}
<script>
        const pucRio = [-22.9794, -43.2329];
        
        const map = L.map('map', {
            center: pucRio,
            zoom: 17,
            minZoom: 15,
            maxZoom: 18
        });

        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            attribution: ''
        }).addTo(map);

        const customIcon = L.divIcon({
            className: 'custom-marker',
            html: '<div style="background-color: #9CCC65; width: 30px; height: 30px; border-radius: 50% 50% 50% 0; transform: rotate(-45deg); border: 3px solid white; box-shadow: 0 2px 5px rgba(0,0,0,0.3);"><div style="width: 10px; height: 10px; background-color: white; border-radius: 50%; position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%) rotate(45deg);"></div></div>',
            iconSize: [30, 30],
            iconAnchor: [15, 30]
        });

        L.marker(pucRio, {icon: customIcon}).addTo(map)
            .bindPopup('PUC-Rio');

        function handleRestaurantClick(event, restaurantId) {
            // Verificar se o clique foi no botão de favorito ou dentro dele
            if (event.target.closest('.favorite-btn')) {
                return; // Não abrir o modal
            }
            openRestaurantModal(restaurantId);
        }

        function openRestaurantModal(restaurantId) {
            const modal = document.getElementById('restaurantModal');
            const modalTitle = document.getElementById('modalRestaurantName');
            const modalBody = document.getElementById('modalRestaurantBody');
            const modalFavoriteBtn = modal.querySelector('.modal-favorite-btn');
            
            // Atualizar ID do restaurante no botão de favoritar do modal
            if (modalFavoriteBtn) {
                modalFavoriteBtn.setAttribute('data-restaurant-id', restaurantId);
                // Atualizar estado visual do botão
                if (window.FavoritesManager) {
                    window.FavoritesManager.updateButton(modalFavoriteBtn, restaurantId);
                }
            }
            
            // Mostrar loading
            modalTitle.textContent = 'Carregando...';
            modalBody.innerHTML = '<div style="text-align: center; padding: 40px;"><p>Carregando cardápio...</p></div>';
            modal.classList.add('active');
            document.body.style.overflow = 'hidden';
            
            // Buscar dados do restaurante
            fetch(`/puceats/api/restaurante/${restaurantId}/menu/`)
                .then(response => {
                    if (!response.ok) {
                        throw new Error('Erro ao carregar cardápio');
                    }
                    return response.json();
                })
                .then(data => {
                    // Armazenar dados dos pratos globalmente
                    allDishesData = data.dishes || [];
                    
                    // Atualizar título
                    modalTitle.textContent = data.name;
                    
                    // Renderizar informações do restaurante
                    let html = `
                        <div class="restaurant-modal-info">
                            ${data.logo ? `<img src="${data.logo}" alt="${data.name}" class="restaurant-modal-logo">` : ''}
                            <div class="restaurant-modal-details">
                                <h3>${data.name}</h3>
                                <div class="restaurant-tags">
                                    ${data.establishment_type ? `<span class="restaurant-tag">${data.establishment_type}</span>` : ''}
                                    ${data.cuisine_type ? `<span class="restaurant-tag">${data.cuisine_type}</span>` : ''}
                                </div>
                                <div class="restaurant-info-grid">
                                    ${data.building ? `
                                        <div class="restaurant-info-line">
                                            <span class="material-icons">location_on</span>
                                            <strong>Prédio:</strong>
                                            <span>${data.building}</span>
                                        </div>
                                    ` : ''}
                                    ${data.opening_hours ? `
                                        <div class="restaurant-info-line">
                                            <span class="material-icons">schedule</span>
                                            <strong>Horário:</strong>
                                            <span>${data.opening_hours}</span>
                                        </div>
                                    ` : ''}
                                    ${data.phone ? `
                                        <div class="restaurant-info-line">
                                            <span class="material-icons">phone</span>
                                            <strong>Telefone:</strong>
                                            <span>${data.phone}</span>
                                        </div>
                                    ` : ''}
                                </div>
                                ${data.description ? `<div class="restaurant-description">${data.description}</div>` : ''}
                            </div>
                        </div>
                        
                        <h3 style="margin-bottom: 16px; color: #333; font-size: 20px;">Cardápio</h3>
                    `;
                    
                    if (data.dishes && data.dishes.length > 0) {
                        // Adicionar barra de busca
                        html += `
                            <div class="dish-search-container">
                                <input type="text" 
                                       class="dish-search-input" 
                                       id="dishSearchInput"
                                       placeholder="Buscar pratos por nome ou descrição...">
                                <span class="material-icons dish-search-icon">search</span>
                            </div>
                        `;
                        
                        const categories = [...new Set(data.dishes.map(dish => dish.category).filter(Boolean))];
                        
                        if (categories.length > 0) {
                            html += '<div class="category-filters">';
                            html += '<button class="category-filter-btn active" data-category="all">Todos</button>';
                            categories.forEach(category => {
                                html += `<button class="category-filter-btn" data-category="${category}">${category}</button>`;
                            });
                            html += '</div>';
                        }
                        
                        html += '<div class="dishes-grid">';
                        data.dishes.forEach(dish => {
                            html += `
                                <div class="dish-card" 
                                     data-category="${dish.category || 'sem-categoria'}"
                                     data-dish-id="${dish.id}"
                                     onclick="openDishDetailModal(${dish.id})">
                                    ${dish.image ? 
                                        `<img src="${dish.image}" alt="${dish.name}" class="dish-image">` : 
                                        `<div class="dish-no-image"><span class="material-icons">restaurant</span></div>`
                                    }
                                    <div class="dish-info">
                                        <h4 class="dish-name">${dish.name}</h4>
                                        ${dish.description ? `<p class="dish-description">${dish.description}</p>` : ''}
                                        <div class="dish-footer">
                                            <span class="dish-price">R$ ${parseFloat(dish.price).toFixed(2)}</span>
                                            ${dish.category ? `<span class="dish-category">${dish.category}</span>` : ''}
                                        </div>
                                    </div>
                                </div>
                            `;
                        });
                        html += '</div>';
                        
                        // Renderizar e adicionar event listeners aos filtros
                        modalBody.innerHTML = html;
                        
                        const filterButtons = modalBody.querySelectorAll('.category-filter-btn');
                        const dishCards = modalBody.querySelectorAll('.dish-card');
                        const searchInput = document.getElementById('dishSearchInput');
                        
                        let currentCategory = 'all';
                        let currentSearchTerm = '';
                        
                        // Função para aplicar todos os filtros
                        function applyFilters() {
                            dishCards.forEach(card => {
                                const category = card.getAttribute('data-category');
                                const dishName = card.querySelector('.dish-name').textContent.toLowerCase();
                                const dishDesc = card.querySelector('.dish-description')?.textContent.toLowerCase() || '';
                                
                                const matchesCategory = currentCategory === 'all' || category === currentCategory;
                                const matchesSearch = currentSearchTerm === '' || 
                                                     dishName.includes(currentSearchTerm) || 
                                                     dishDesc.includes(currentSearchTerm);
                                
                                if (matchesCategory && matchesSearch) {
                                    card.style.display = 'block';
                                } else {
                                    card.style.display = 'none';
                                }
                            });
                        }
                        
                        // Event listener para filtro de categoria
                        filterButtons.forEach(btn => {
                            btn.addEventListener('click', function() {
                                currentCategory = this.getAttribute('data-category');
                                
                                // Atualizar botão ativo
                                filterButtons.forEach(b => b.classList.remove('active'));
                                this.classList.add('active');
                                
                                applyFilters();
                            });
                        });
                        
                        // Event listener para busca
                        if (searchInput) {
                            searchInput.addEventListener('input', function() {
                                currentSearchTerm = this.value.toLowerCase();
                                applyFilters();
                            });
                        }
                    } else {
                        html += '<p style="text-align: center; color: #666; padding: 40px;">Nenhum prato disponível no momento.</p>';
                        modalBody.innerHTML = html;
                    }
                })
                .catch(error => {
                    console.error('Erro:', error);
                    modalTitle.textContent = 'Erro';
                    modalBody.innerHTML = '<div style="text-align: center; padding: 40px;"><p style="color: #D32F2F;">Não foi possível carregar o cardápio. Tente novamente.</p></div>';
                });
        }

        function closeRestaurantModal() {
            const modal = document.getElementById('restaurantModal');
            modal.classList.remove('active');
            document.body.style.overflow = '';
        }

        // Event listener para fechar com ESC
        document.addEventListener('keydown', function(event) {
            if (event.key === 'Escape') {
                const modal = document.getElementById('restaurantModal');
                if (modal.classList.contains('active')) {
                    closeRestaurantModal();
                }
            }
        });

        // Event listener para fechar clicando fora do modal
        document.getElementById('restaurantModal').addEventListener('click', function(event) {
            if (event.target === this) {
                closeRestaurantModal();
            }
        });

        // Armazenar dados dos pratos globalmente
        let allDishesData = [];

        function openDishDetailModal(dishId) {
            const dish = allDishesData.find(d => d.id === dishId);
            if (!dish) return;

            const modal = document.getElementById('dishDetailModal');
            const modalTitle = document.getElementById('dishDetailName');
            const modalBody = document.getElementById('dishDetailBody');

            modalTitle.textContent = dish.name;

            let html = `
                <div class="dish-detail-image-container">
                    ${dish.image ? 
                        `<img src="${dish.image}" alt="${dish.name}" class="dish-detail-image">` : 
                        `<div class="dish-no-image" style="height: 300px;"><span class="material-icons">restaurant</span></div>`
                    }
                </div>

                <div class="dish-detail-price">R$ ${parseFloat(dish.price).toFixed(2)}</div>

                ${dish.category ? `
                    <div class="dish-detail-section">
                        <h3>Categoria</h3>
                        <p>${dish.category}</p>
                    </div>
                ` : ''}

                ${dish.description ? `
                    <div class="dish-detail-section">
                        <h3>Descrição</h3>
                        <p>${dish.description}</p>
                    </div>
                ` : ''}

                ${(dish.is_vegan || dish.is_vegetarian || dish.is_gluten_free) ? `
                    <div class="dish-detail-section">
                        <h3>Informações Dietéticas</h3>
                        <div class="dish-detail-tags">
                            ${dish.is_vegan ? '<span class="dish-detail-tag vegan"><span class="material-icons">eco</span>Vegano</span>' : ''}
                            ${dish.is_vegetarian ? '<span class="dish-detail-tag vegetarian"><span class="material-icons">local_florist</span>Vegetariano</span>' : ''}
                            ${dish.is_gluten_free ? '<span class="dish-detail-tag gluten-free"><span class="material-icons">grain</span>Sem Glúten</span>' : ''}
                        </div>
                    </div>
                ` : ''}
            `;

            modalBody.innerHTML = html;
            modal.classList.add('active');
        }

        function closeDishDetailModal() {
            const modal = document.getElementById('dishDetailModal');
            modal.classList.remove('active');
        }

        // Event listeners para modal de detalhes
        document.addEventListener('keydown', function(event) {
            if (event.key === 'Escape') {
                const dishModal = document.getElementById('dishDetailModal');
                if (dishModal.classList.contains('active')) {
                    closeDishDetailModal();
                }
            }
        });

        document.getElementById('dishDetailModal').addEventListener('click', function(event) {
            if (event.target === this) {
                closeDishDetailModal();
            }
        });

        // Sistema de Busca de Restaurantes e Pratos
        const searchInputDesktop = document.getElementById('restaurantSearchInput');
        const searchInputMobile = document.getElementById('restaurantSearchInputMobile');
        const clearBtnDesktop = document.getElementById('searchClearBtn');
        const clearBtnMobile = document.getElementById('searchClearBtnMobile');
        
        // Cache para armazenar dados dos pratos
        const dishesCache = {};

        async function fetchRestaurantDishes(restaurantId) {
            if (dishesCache[restaurantId]) {
                return dishesCache[restaurantId];
            }

            try {
                const response = await fetch(`/puceats/api/restaurante/${restaurantId}/menu/`);
                const data = await response.json();
                
                if (data.success && data.dishes) {
                    dishesCache[restaurantId] = data.dishes;
                    return data.dishes;
                }
            } catch (error) {
                console.error(`Erro ao buscar pratos do restaurante ${restaurantId}:`, error);
            }
            
            return [];
        }

        // Função para remover acentos e normalizar texto
        function normalizeText(text) {
            return text.normalize('NFD').replace(/[\u0300-\u036f]/g, '').toLowerCase();
        }

        // Função de match melhorada
        function smartMatch(text, searchTerms) {
            const normalizedText = normalizeText(text);
            
            // Verificar se todas as palavras do termo de busca estão presentes
            return searchTerms.every(term => normalizedText.includes(term));
        }

        async function filterRestaurants(searchTerm) {
            const term = searchTerm.trim();
            const restaurantItems = document.querySelectorAll('.restaurant-item');
            let visibleCount = 0;

            if (term === '') {
                // Sem termo de busca, mostrar todos
                restaurantItems.forEach(item => {
                    item.style.display = 'flex';
                    const badge = item.querySelector('.search-match-badge');
                    if (badge) badge.remove();
                });
                
                const noResultsMsg = document.getElementById('noResultsMessage');
                if (noResultsMsg) {
                    noResultsMsg.style.display = 'none';
                }
                return;
            }

            // Dividir termo em palavras e normalizar
            const searchTerms = normalizeText(term).split(/\s+/).filter(t => t.length > 0);

            // Processar cada restaurante
            const promises = Array.from(restaurantItems).map(async (item) => {
                const name = item.querySelector('.restaurant-name')?.textContent || '';
                const cuisine = item.querySelector('.restaurant-cuisine')?.textContent || '';
                const location = item.querySelector('.restaurant-location')?.textContent || '';

                // Verificar match nos dados do restaurante
                const restaurantMatch = smartMatch(name, searchTerms) || 
                                       smartMatch(cuisine, searchTerms) || 
                                       smartMatch(location, searchTerms);

                // Buscar nos pratos
                const restaurantId = item.getAttribute('onclick')?.match(/\d+/)?.[0];
                let dishMatch = false;
                let matchedDish = null;
                let matchCount = 0;

                if (restaurantId) {
                    const dishes = await fetchRestaurantDishes(restaurantId);
                    for (const dish of dishes) {
                        const dishName = dish.name || '';
                        const dishDesc = dish.description || '';
                        
                        if (smartMatch(dishName, searchTerms) || smartMatch(dishDesc, searchTerms)) {
                            dishMatch = true;
                            matchCount++;
                            if (!matchedDish) {
                                matchedDish = dish.name;
                            }
                        }
                    }
                }

                // Remover badge anterior se existir
                const oldBadge = item.querySelector('.search-match-badge');
                if (oldBadge) oldBadge.remove();

                // Mostrar/ocultar restaurante
                if (restaurantMatch || dishMatch) {
                    item.style.display = 'flex';
                    visibleCount++;

                    // Adicionar badge se o match foi por prato
                    if (dishMatch && !restaurantMatch) {
                        const badge = document.createElement('span');
                        badge.className = 'search-match-badge';
                        if (matchCount === 1) {
                            badge.innerHTML = `<span class="material-icons">restaurant_menu</span> ${matchedDish}`;
                        } else {
                            badge.innerHTML = `<span class="material-icons">restaurant_menu</span> ${matchCount} pratos encontrados`;
                        }
                        item.querySelector('.restaurant-info').appendChild(badge);
                    }
                } else {
                    item.style.display = 'none';
                }
            });

            await Promise.all(promises);

            const noResultsMsg = document.getElementById('noResultsMessage');
            if (noResultsMsg) {
                noResultsMsg.style.display = visibleCount === 0 ? 'block' : 'none';
            }
        }

        function toggleClearButton(input, clearBtn) {
            if (clearBtn) {
                clearBtn.style.display = input.value.length > 0 ? 'flex' : 'none';
            }
        }

        if (searchInputDesktop) {
            searchInputDesktop.addEventListener('input', function(e) {
                filterRestaurants(e.target.value);
                toggleClearButton(searchInputDesktop, clearBtnDesktop);
            });
        }

        if (searchInputMobile) {
            searchInputMobile.addEventListener('input', function(e) {
                filterRestaurants(e.target.value);
                toggleClearButton(searchInputMobile, clearBtnMobile);
            });
        }

        if (clearBtnDesktop) {
            clearBtnDesktop.addEventListener('click', function() {
                searchInputDesktop.value = '';
                filterRestaurants('');
                toggleClearButton(searchInputDesktop, clearBtnDesktop);
                searchInputDesktop.focus();
            });
        }

        if (clearBtnMobile) {
            clearBtnMobile.addEventListener('click', function() {
                searchInputMobile.value = '';
                filterRestaurants('');
                toggleClearButton(searchInputMobile, clearBtnMobile);
                searchInputMobile.focus();
            });
        }

</script>
{% endblock %}