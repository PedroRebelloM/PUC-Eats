{% extends 'base.html' %}
{% load static %}

{% block title %}Favoritos • PUC Eats{% endblock %}

{% block nav_favoritos %}active{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="{% static 'css/styleFavoritos.css' %}" />
{% endblock %}

{% block content %}
<div class="page">
    <div class="page-header">
        <div class="header-icon-wrapper">
            <span class="material-icons">favorite</span>
        </div>
        <div>
            <h2 class="page-title">Seus Restaurantes Favoritos</h2>
            <p class="page-description" id="favoritesCount">Carregando...</p>
        </div>
    </div>

    <section class="favorites-grid" id="favoritesGrid">
        <div style="text-align: center; padding: 40px;">
            <p>Carregando favoritos...</p>
        </div>
    </section>
    
    <!-- Template vazio quando não há favoritos -->
    <div id="emptyState" style="display: none; text-align: center; padding: 60px 20px;">
        <span class="material-icons" style="font-size: 80px; color: #ccc;">favorite_border</span>
        <h3 style="color: #666; margin-top: 20px;">Nenhum favorito ainda</h3>
        <p style="color: #999; margin-top: 10px;">Explore os restaurantes e adicione seus favoritos clicando no coração</p>
        <a href="{% url 'puceats:index' %}" style="display: inline-block; margin-top: 20px; padding: 12px 24px; background: #9CCC65; color: white; text-decoration: none; border-radius: 8px;">
            Explorar Restaurantes
        </a>
    </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    const favoritesGrid = document.getElementById('favoritesGrid');
    const emptyState = document.getElementById('emptyState');
    const favoritesCount = document.getElementById('favoritesCount');
    
    const favorites = window.FavoritesManager ? window.FavoritesManager.getFavorites() : [];
    
    if (favorites.length === 0) {
        favoritesGrid.style.display = 'none';
        emptyState.style.display = 'block';
        favoritesCount.textContent = 'Você ainda não tem favoritos';
        return;
    }
    
    favoritesCount.textContent = `${favorites.length} ${favorites.length === 1 ? 'restaurante' : 'restaurantes'}`;
    
    // Event delegation para botões de favorito
    favoritesGrid.addEventListener('click', function(e) {
        const favoriteBtn = e.target.closest('.favorite-btn');
        if (favoriteBtn) {
            e.stopPropagation();
            const restaurantId = parseInt(favoriteBtn.dataset.restaurantId);
            removeFavorite(restaurantId);
            return;
        }
        
        const card = e.target.closest('.favorite-card');
        if (card) {
            const restaurantId = card.dataset.restaurantId;
            window.location.href = `{% url "puceats:index" %}?open=${restaurantId}`;
        }
    });
    
    // Renderizar favoritos diretamente usando a API
    renderFavorites(favorites);
});

function renderFavorites(favoriteIds) {
    const grid = document.getElementById('favoritesGrid');
    grid.innerHTML = '<div style="text-align: center; padding: 40px;"><p>Carregando restaurantes...</p></div>';
    
    console.log('Carregando favoritos:', favoriteIds);
    
    const promises = favoriteIds.map(id => 
        fetch(`/puceats/api/restaurante/${id}/menu/`)
            .then(r => {
                console.log(`Resposta da API para ID ${id}:`, r.status);
                return r.json();
            })
            .then(data => {
                console.log(`Dados recebidos para ID ${id}:`, data);
                return data;
            })
            .catch(err => {
                console.error(`Erro ao carregar restaurante ${id}:`, err);
                return null;
            })
    );
    
    Promise.all(promises).then(restaurants => {
        console.log('Todos os restaurantes:', restaurants);
        const validRestaurants = restaurants.filter(r => r && r.success !== false);
        console.log('Restaurantes válidos:', validRestaurants);
        
        if (validRestaurants.length === 0) {
            grid.innerHTML = '<p style="text-align: center; padding: 40px; color: #666;">Nenhum restaurante encontrado</p>';
            return;
        }
        
        grid.innerHTML = validRestaurants.map(restaurant => `
            <article class="favorite-card" data-restaurant-id="${restaurant.id}" style="cursor: pointer;">
                <div class="card-image">
                    ${restaurant.logo ? `<img src="${restaurant.logo}" alt="${restaurant.name}" />` : 
                      `<div class="restaurant-placeholder" style="width: 100%; height: 200px; background: #f5f5f5; display: flex; align-items: center; justify-content: center;"><span class="material-icons" style="font-size: 48px; color: #ccc;">restaurant</span></div>`}
                    <button class="favorite-btn active" data-restaurant-id="${restaurant.id}">
                        <span class="material-icons">favorite</span>
                    </button>
                </div>
                <div class="card-content">
                    <h3 class="card-title">${restaurant.name}</h3>
                    <p class="card-category">${restaurant.establishment_type || ''} ${restaurant.cuisine_type ? '• ' + restaurant.cuisine_type : ''}</p>
                    ${restaurant.building ? `<p class="card-location"><span class="material-icons location-icon">place</span>${restaurant.building}</p>` : ''}
                </div>
            </article>
        `).join('');
    }).catch(() => {
        grid.innerHTML = '<p style="text-align: center; padding: 40px; color: #E53935;">Erro ao carregar favoritos. Tente novamente.</p>';
    });
}

function removeFavorite(restaurantId) {
    if (window.FavoritesManager) {
        window.FavoritesManager.removeFavorite(restaurantId);
        setTimeout(() => {
            window.location.reload();
        }, 300);
    }
}
</script>
{% endblock %}
